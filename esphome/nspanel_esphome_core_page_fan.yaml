#####################################################################################################
##### NSPANEL ESPHOME created by Blackymas - https://github.com/Blackymas/NSPanel_HA_Blueprint  #####
##### ESPHOME CORE - Page Fan                                                                   #####
##### PLEASE only make changes if it is necessary and also the required knowledge is available. #####
##### For normal use with the Blueprint, no changes are necessary.                              #####
#####################################################################################################

---
substitutions:
  BOOT_STEP_PAGE_FAN: '1UL << 16'

display:
  - id: !extend disp1
    on_touch:
      then:
        - lambda: |-
            if (page_id == 22) {  // Page Fan
              switch (component_id) {
                case 11:  // bt_oscillate
                  if (!touch_event) {  // Release
                    ha_call_action->execute("fan.oscillate", "oscillating", "toggle", detailed_entity->state.c_str());
                  }
                  break;
                case 12:  // power_button
                  if (!touch_event) {  // Release
                    ha_call_action->execute("fan.toggle", "", "", detailed_entity->state.c_str());
                  }
                  break;
              }
            }

script:
  - id: !extend boot_progress_dump
    then:
      - script.execute:
          id: boot_progress_dump_item
          step: ${BOOT_STEP_PAGE_FAN}
          step_name: Page Fan

  - id: !extend boot_sequence
    then:
      - script.execute:
          id: boot_progress
          step: ${BOOT_STEP_PAGE_FAN}
          step_name: Page Fan

  - id: !extend event_from_display
    then:
      - if:
          condition:
            - lambda: return page == "fan";
          then:
            - if:
                condition:
                  - or:
                      - lambda: return key == "stop";
                      - lambda: return value == "0";
                then:
                  - script.execute:
                      id: ha_call_action
                      action: fan.turn_off
                      key: ''
                      value: ''
                      entity: !lambda return detailed_entity->state.c_str();
                else:
                  - script.execute:
                      id: ha_call_action
                      action: fan.turn_on
                      key: !lambda return key.c_str();
                      value: !lambda return value.c_str();
                      entity: !lambda return detailed_entity->state.c_str();

#   - id: !extend page_changed
#     then:
#       - lambda: |-
#           if (current_page->state == "fan") page_fan->execute();

#   - id: page_fan
#     mode: restart
#     then:  # There's nothing here so far

#   - id: !extend stop_all
#     then:
#       - script.stop: page_fan
...
