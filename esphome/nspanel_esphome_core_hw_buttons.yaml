#####################################################################################################
##### NSPANEL ESPHOME created by Blackymas - https://github.com/Blackymas/NSPanel_HA_Blueprint  #####
##### ESPHOME CORE - HARDWARE - BUTTONS                                                         #####
##### PLEASE only make changes if it is necessary and also the required knowledge is available. #####
##### For normal use with the Blueprint, no changes are necessary.                              #####
#####################################################################################################

---
substitutions:
  ##############################
  ## Change only in your      ##
  ## local yaml substitutions ##
  invalid_cooldown: "100ms"
  buttons_color_on: "7519"
  buttons_color_off: "10597"
  ##############################
  BOOT_STEP_HW_BUTTONS: '1UL << 3'

binary_sensor:
  ###### LEFT BUTTON BELOW DISPLAY TO TOGGLE RELAY#####
  - name: Left Button
    platform: gpio
    id: left_button
    pin:
      number: 14
      inverted: true
    on_press: &hardware_button_on_press
      then:
        - if:
            condition:
              - switch.is_on: hw_button_wakeup
            then:
              - if:
                  condition:
                    - text_sensor.state:
                        id: current_page
                        state: screensaver
                  then:
                    - script.execute:
                        id: goto_page
                        page: !lambda return wakeup_page_name->state.c_str();
              - script.execute: timer_dim
              - script.execute: timer_sleep
    on_multi_click:
      - timing: &long_click-timing
          - ON for at least 0.8s
        invalid_cooldown: ${invalid_cooldown}
        then:
          - logger.log: Left button - Long click
          - script.execute:
              id: ha_button
              page: !lambda return current_page->state.c_str();
              component: hw_bt_left
              command: long_click
      - timing: &short_click-timing
          - ON for at most 0.8s
        invalid_cooldown: ${invalid_cooldown}
        then:
          - logger.log: Left button - Short click
          - if:
              condition:
                or:
                  - lambda: return id(relay1_local);
                  - and:
                      - lambda: return id(relay1_fallback);
                      - or:
                          - not:
                              - api.connected:
                          - not:
                              - wifi.connected:
              then:
                - switch.toggle: relay_1
          - script.execute:
              id: ha_button
              page: !lambda return current_page->state.c_str();
              component: hw_bt_left
              command: short_click

  ##### RIGHT BUTTON BELOW DISPLAY TO TOGGLE RELAY #####
  - name: Right Button
    platform: gpio
    id: right_button
    pin:
      number: 27
      inverted: true
    on_press: *hardware_button_on_press
    on_multi_click:
      - timing: *long_click-timing
        invalid_cooldown: ${invalid_cooldown}
        then:
          - logger.log: Right button - Long click
          - script.execute:
              id: ha_button
              page: !lambda return current_page->state.c_str();
              component: hw_bt_right
              command: long_click
      - timing: *short_click-timing
        invalid_cooldown: ${invalid_cooldown}
        then:
          - logger.log: Right button - Short click
          - if:
              condition:
                or:
                  - lambda: return id(relay2_local);
                  - and:
                      - lambda: return id(relay2_fallback);
                      - or:
                          - not:
                              - api.connected:
                          - not:
                              - wifi.connected:
              then:
                - switch.toggle: relay_2
          - script.execute:
              id: ha_button
              page: !lambda return current_page->state.c_str();
              component: hw_bt_right
              command: short_click

globals:
  - id: button_left_enabled
    type: bool
    restore_value: false
    initial_value: 'false'
  - id: button_left_state
    type: bool
    restore_value: false
    initial_value: 'false'
  - id: button_right_enabled
    type: bool
    restore_value: false
    initial_value: 'false'
  - id: button_right_state
    type: bool
    restore_value: false
    initial_value: 'false'

  - id: buttons_color_on
    type: uint16_t
    restore_value: true
    initial_value: '${buttons_color_on}'
  - id: buttons_color_off
    type: uint16_t
    restore_value: true
    initial_value: '${buttons_color_off}'
  - id: buttons_bars_pages
    type: uint32_t
    restore_value: true
    initial_value: '1'

script:
  - id: !extend boot_progress_dump  # Defined by nspanel_esphome_core_boot.yaml
    then:
      - script.execute:
          id: boot_progress_dump_item
          step: ${BOOT_STEP_HW_BUTTONS}
          step_name: HW Buttons

  - id: !extend page_changed  # Defined by nspanel_esphome_core_hw_display.yaml
    then:
      - &refresh_hardware_buttons_bars_3
        script.execute:
          id: refresh_hardware_buttons_bars
          button_mask: 3
      - delay: 1s
      - *refresh_hardware_buttons_bars_3

  - id: refresh_hardware_buttons_bars
    mode: restart
    parameters:
      button_mask: uint8_t
    then:
      - lambda: |-
          if ((id(buttons_bars_pages) & (1 << get_page_id(current_page->state.c_str()))) != 0) {
            switch (int(display_mode->state)) {
              case 1:  // EU model
                if (button_mask & 1 and id(button_left_enabled)) {  // Left button
                  disp1->fill_area(48, 307, 118, 3, id(button_left_state) ? id(buttons_color_on) : id(buttons_color_off));
                  disp1->fill_area(47, 308, 120, 1, id(button_left_state) ? id(buttons_color_on) : id(buttons_color_off));
                }
                if (button_mask & 2 and id(button_right_enabled)) {  // Right button
                  disp1->fill_area(289, 307, 118, 3, id(button_right_state) ? id(buttons_color_on) : id(buttons_color_off));
                  disp1->fill_area(288, 308, 120, 1, id(button_right_state) ? id(buttons_color_on) : id(buttons_color_off));
                }
                break;
              case 2:  // US Portrait
                if (button_mask & 1 and id(button_left_enabled)) {  // Left button
                  disp1->fill_area(17, 466, 118, 3, id(button_left_state) ? id(buttons_color_on) : id(buttons_color_off));
                  disp1->fill_area(16, 467, 120, 1, id(button_left_state) ? id(buttons_color_on) : id(buttons_color_off));
                }
                if (button_mask & 2 and id(button_right_enabled)) {  // Right button
                  disp1->fill_area(184, 466, 118, 3, id(button_right_state) ? id(buttons_color_on) : id(buttons_color_off));
                  disp1->fill_area(183, 467, 120, 1, id(button_right_state) ? id(buttons_color_on) : id(buttons_color_off));
                }
                break;
              case 3:  // US Landscape
                if (button_mask & 1 and id(button_left_enabled)) {  // Left button
                  disp1->fill_area(467, 174, 3, 118, id(button_left_state) ? id(buttons_color_on) : id(buttons_color_off));
                  disp1->fill_area(468, 173, 1, 120, id(button_left_state) ? id(buttons_color_on) : id(buttons_color_off));
                }
                if (button_mask & 2 and id(button_right_enabled)) {  // Right button
                  disp1->fill_area(467, 28, 3, 118, id(button_right_state) ? id(buttons_color_on) : id(buttons_color_off));
                  disp1->fill_area(468, 27, 1, 120, id(button_right_state) ? id(buttons_color_on) : id(buttons_color_off));
                }
                break;
            }
          }

  - id: !extend set_component_font_color  # Defined by nspanel_esphome_core_hw_display.yaml
    then:
      - lambda: |-
          if (component_id == "button_bar_color_on") id(buttons_color_on) = color;
          else if (component_id == "button_bar_color_off") id(buttons_color_off) = color;

  - id: !extend set_var_int  # Defined by nspanel_esphome_core_base.yaml
    then:
      - lambda: |-
          if (component == "hw_button_state" and val >= 0) {
            id(button_left_enabled) = ((val & 0x03) == 3) ? false
                                    : ((val & 0x03) == 1 || (val & 0x03) == 2) ? true
                                    : id(button_left_enabled);
            id(button_left_state) = ((val & 0x03) == 1) ? true
                                  : ((val & 0x03) == 2) ? false
                                  : id(button_left_state);
            id(button_right_enabled) = (((val >> 2) & 0x03) == 3) ? false
                                      : (((val >> 2) & 0x03) == 1 || ((val >> 2) & 0x03) == 2) ? true
                                      : id(button_right_enabled);
            id(button_right_state) = (((val >> 2) & 0x03) == 1) ? true
                                    : (((val >> 2) & 0x03) == 2) ? false
                                    : id(button_right_state);
            refresh_hardware_buttons_bars->execute(
                (((val & 0x03) != 0) ? 1 : 0) +
                (((val >> 2) & 0x03) != 0 ? 1 : 0)
            );
          } else if (component == "button_bar_color_on" and val >= 0) id(buttons_color_on) = val;
          else if (component == "button_bar_color_off" and val >= 0) id(buttons_color_off) = val;
          else if (component == "buttons_bars_pages" and val >= 0) {
            id(buttons_bars_pages) = val;
            boot_progress->execute(${BOOT_STEP_HW_BUTTONS}, "HW Buttons");
          }

  - id: !extend stop_all  # Defined by nspanel_esphome_core_base.yaml
    then:
      - script.stop: refresh_hardware_buttons_bars

time:
  - id: !extend time_provider
    on_time:
      - seconds: 0
        then:
          - *refresh_hardware_buttons_bars_3
...
